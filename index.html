<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FleetAnalytics | Dashboard Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #0b0f19; color: #f8fafc; font-family: 'Inter', sans-serif; }
        .card-pro { background: #161b26; border: 1px solid rgba(255,255,255,0.05); border-radius: 1rem; }
        
        /* Dropdowns Estilo Power BI */
        .dropdown-container { position: relative; width: 100%; }
        .dropdown-btn { 
            background: #1f2937; border: 1px solid #374151; padding: 0.75rem 1rem; border-radius: 0.5rem; 
            width: 100%; display: flex; justify-content: space-between; align-items: center; cursor: pointer;
        }
        .dropdown-content { 
            display: none; position: absolute; top: 105%; left: 0; width: 100%; min-width: 280px;
            background: #1f2937; border: 1px solid #38bdf8; border-radius: 0.5rem; z-index: 999; 
            max-height: 300px; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.5); padding: 5px;
        }
        .dropdown-content.show { display: block; }
        
        .option-row { display: flex; align-items: center; padding: 0.7rem 1rem; cursor: pointer; border-radius: 0.4rem; transition: 0.2s; }
        .option-row:hover { background: #374151; }
        
        /* Checkbox Visual */
        .check-box { 
            width: 18px; height: 18px; border: 2px solid #4b5563; border-radius: 4px; 
            margin-right: 12px; position: relative; flex-shrink: 0;
        }
        .option-row.selected .check-box { background: #38bdf8; border-color: #38bdf8; }
        .option-row.selected .check-box::after { 
            content: '✓'; position: absolute; color: white; font-size: 12px; left: 3px; top: -1px; font-weight: bold;
        }
        
        .badge { background: #38bdf8; color: #000; font-size: 0.7rem; font-weight: 800; padding: 1px 6px; border-radius: 10px; margin-left: auto; }
    </style>
</head>
<body class="p-6">

    <div class="max-w-7xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <h1 class="text-2xl font-bold">Fleet<span class="text-sky-500">Analytics</span></h1>
            <div class="flex gap-3">
                <label class="bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded font-bold text-sm cursor-pointer border border-slate-600">
                    <i class="fas fa-upload mr-2"></i>Upload CSV
                    <input type="file" accept=".csv" class="hidden" onchange="loadLocalFile(event)">
                </label>
                <button onclick="loadFromDrive()" class="bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded font-bold text-sm flex items-center gap-2">
                    <i class="fas fa-sync" id="spin"></i> Atualizar Drive
                </button>
            </div>
        </div>

        <div class="card-pro p-6 mb-8 grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="dropdown-container">
                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Embarcação</label>
                <div class="dropdown-btn" onclick="toggleDrop('drop-barco')"><span id="txt-barco">Todas</span> <i class="fas fa-chevron-down opacity-30"></i></div>
                <div id="drop-barco" class="dropdown-content">
                    <div class="p-2"><input type="text" placeholder="Buscar..." class="w-full bg-slate-900 p-2 rounded text-sm outline-none" onkeyup="filterRows('list-barco', this.value)"></div>
                    <div id="list-barco"></div>
                </div>
            </div>
            <div class="dropdown-container">
                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Tipo de Barco</label>
                <div class="dropdown-btn" onclick="toggleDrop('drop-tipo')"><span id="txt-tipo">Todos</span> <i class="fas fa-chevron-down opacity-30"></i></div>
                <div id="drop-tipo" class="dropdown-content"><div id="list-tipo"></div></div>
            </div>
            <div class="dropdown-container">
                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Ano</label>
                <div class="dropdown-btn" onclick="toggleDrop('drop-ano')"><span id="txt-ano">Todos</span> <i class="fas fa-chevron-down opacity-30"></i></div>
                <div id="drop-ano" class="dropdown-content"><div id="list-ano"></div></div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="card-pro p-5 border-l-4 border-sky-500"><p class="text-slate-500 text-xs font-bold uppercase mb-1">Total Notificado</p><h2 id="kpi-total" class="text-xl font-bold text-white">R$ 0,00</h2></div>
            <div class="card-pro p-5 border-l-4 border-emerald-500"><p class="text-slate-500 text-xs font-bold uppercase mb-1">Saving Total</p><h2 id="kpi-saving" class="text-xl font-bold text-emerald-400">R$ 0,00</h2></div>
            <div class="card-pro p-5 border-l-4 border-amber-500"><p class="text-slate-500 text-xs font-bold uppercase mb-1">Volume Total</p><h2 id="kpi-vol" class="text-xl font-bold text-amber-500">0 m³</h2></div>
            <div class="card-pro p-5 border-l-4 border-indigo-500"><p class="text-slate-500 text-xs font-bold uppercase mb-1">Volumes por Ano</p><div id="year-stats" class="text-[10px] space-y-1 mt-1"></div></div>
        </div>

        <div class="card-pro p-8">
            <h3 class="text-xs font-bold uppercase mb-6 text-slate-500 tracking-widest">Impacto por Embarcação (BRL)</h3>
            <div class="h-[400px]"><canvas id="mainChart"></canvas></div>
        </div>
    </div>

    <script>
        const DRIVE_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRkYmpE1Ja82Ek-qo39K1rQUfZhDm2MSdP_L1-nzfqFBVJTGoOQMzlHOIjH5x_ITZ-iGHz90PKSGqfE/pub?gid=2043405360&single=true&output=csv';
        
        let rawData = [];
        let filters = { barco: [], tipo: [], ano: [] };
        let chart = null;

        // Inicia carregando do Drive
        window.onload = loadFromDrive;

        // Fecha dropdowns
        window.onclick = e => { if(!e.target.closest('.dropdown-container')) document.querySelectorAll('.dropdown-content').forEach(d=>d.classList.remove('show')); };

        function toggleDrop(id) {
            const el = document.getElementById(id);
            const isShow = el.classList.contains('show');
            document.querySelectorAll('.dropdown-content').forEach(d=>d.classList.remove('show'));
            if(!isShow) el.classList.add('show');
        }

        async function loadFromDrive() {
            document.getElementById('spin').classList.add('fa-spin');
            Papa.parse(DRIVE_URL, {
                download: true, header: true, skipEmptyLines: true,
                complete: r => process(r.data),
                error: () => alert("Erro ao carregar link. Certifique-se de que a planilha está publicada como CSV.")
            });
        }

        function loadLocalFile(e) {
            const file = e.target.files[0];
            if(file) Papa.parse(file, { header: true, skipEmptyLines: true, complete: r => process(r.data) });
        }

        // FUNÇÃO DE DETECÇÃO DINÂMICA DE COLUNAS
        function getCol(data, keywords) {
            const keys = Object.keys(data[0]);
            return keys.find(k => keywords.some(kw => k.toLowerCase().trim().includes(kw.toLowerCase())));
        }

        function process(data) {
            // Filtra linhas vazias e identifica a coluna do Barco
            const kBarco = getCol(data, ['barco']);
            rawData = data.filter(d => d[kBarco] && d[kBarco].trim() !== "" && d[kBarco] !== 'Total');
            
            buildFilterOptions();
            updateDashboard();
            document.getElementById('spin').classList.remove('fa-spin');
        }

        function buildFilterOptions() {
            const kBarco = getCol(rawData, ['barco']);
            const kTipo = getCol(rawData, ['tipo']);
            const kAno = getCol(rawData, ['ano']);

            const create = (key, listId, filterType) => {
                const unique = [...new Set(rawData.map(d => d[key]))].filter(x => x).sort();
                document.getElementById(listId).innerHTML = unique.map(v => `
                    <div class="option-row" onclick="toggleSelection('${filterType}', '${v}', this)">
                        <div class="check-box"></div><span>${v}</span>
                    </div>
                `).join('');
            };

            if(kBarco) create(kBarco, 'list-barco', 'barco');
            if(kTipo) create(kTipo, 'list-tipo', 'tipo');
            if(kAno) create(kAno, 'list-ano', 'ano');
        }

        function toggleSelection(type, val, el) {
            const idx = filters[type].indexOf(val);
            if(idx > -1) { filters[type].splice(idx, 1); el.classList.remove('selected'); }
            else { filters[type].push(val); el.classList.add('selected'); }
            
            const btnText = filters[type].length === 0 ? 'Todas' : `${filters[type].length} selecionado(s)`;
            document.getElementById(`txt-${type}`).innerText = btnText;
            updateDashboard();
        }

        function cleanNum(v) {
            if(!v) return 0;
            let n = v.toString().replace('R$', '').replace(/\s/g, '');
            if(n.includes(',') && n.includes('.')) n = n.replace(/\./g, '').replace(',', '.');
            else n = n.replace(',', '.');
            return parseFloat(n) || 0;
        }

        function updateDashboard() {
            const kB = getCol(rawData, ['barco']);
            const kT = getCol(rawData, ['tipo']);
            const kA = getCol(rawData, ['ano']);
            const kV = getCol(rawData, ['valor inicial', 'valor total']);
            const kS = getCol(rawData, ['saving']);
            const kVol = getCol(rawData, ['volume cobrado']);

            const filtered = rawData.filter(d => {
                return (filters.barco.length === 0 || filters.barco.includes(d[kB])) &&
                       (filters.tipo.length === 0 || filters.tipo.includes(d[kT])) &&
                       (filters.ano.length === 0 || filters.ano.includes(d[kA]));
            });

            let tN = 0, tS = 0, tV = 0;
            const bMap = {}, yMap = {};

            filtered.forEach(d => {
                const n = cleanNum(d[kV]), s = cleanNum(d[kS]), v = cleanNum(d[kVol]);
                tN += n; tS += s; tV += v;
                bMap[d[kB]] = (bMap[d[kB]] || 0) + n;
                yMap[d[kA]] = (yMap[d[kA]] || 0) + v;
            });

            document.getElementById('kpi-total').innerText = tN.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('kpi-saving').innerText = tS.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('kpi-vol').innerText = tV.toLocaleString('pt-BR') + ' m³';
            
            document.getElementById('year-stats').innerHTML = Object.keys(yMap).sort().map(y => 
                `<div class="flex justify-between border-b border-slate-800 pb-1"><span>${y}:</span><span class="font-bold text-slate-300">${yMap[y].toLocaleString('pt-BR')} m³</span></div>`
            ).join('');

            renderChart(bMap);
        }

        function renderChart(data) {
            const sorted = Object.entries(data).sort((a,b)=>b[1]-a[1]).slice(0, 10);
            const ctx = document.getElementById('mainChart').getContext('2d');
            if(chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(x=>x[0]),
                    datasets: [{ label: 'BRL', data: sorted.map(x=>x[1]), backgroundColor: '#38bdf8', borderRadius: 8 }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { display: false } },
                    scales: { y: { grid:{color:'#1e2937'}, ticks:{color:'#64748b'} }, x: { ticks:{color:'#94a3b8'} } }
                }
            });
        }

        function filterRows(id, val) {
            const rows = document.querySelectorAll(`#${id} .option-row`);
            rows.forEach(r => r.style.display = r.innerText.toLowerCase().includes(val.toLowerCase()) ? 'flex' : 'none');
        }
    </script>
</body>
</html>