<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FleetAnalytics V26 | Solução de Link</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --bg: #020617; --card: #0f172a; --accent: #38bdf8; }
        body { background-color: var(--bg); color: #f1f5f9; font-family: 'Inter', sans-serif; }
        .card-v26 { background: var(--card); border: 1px solid #1e293b; border-radius: 0.75rem; }
        
        /* Dropdown Estilo Power BI */
        .dropdown-menu { 
            display: none; position: absolute; top: 105%; left: 0; width: 100%; 
            background: #1e293b; border: 1px solid var(--accent); border-radius: 0.5rem; 
            z-index: 1000; max-height: 280px; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5);
        }
        .dropdown-menu.show { display: block; }
        
        .option-row { display: flex; align-items: center; padding: 10px 14px; cursor: pointer; border-bottom: 1px solid #0f172a; }
        .option-row:hover { background: #334155; }
        
        .check-ui { width: 18px; height: 18px; border: 2px solid #475569; border-radius: 4px; margin-right: 12px; position: relative; flex-shrink: 0; }
        .selected .check-ui { background: var(--accent); border-color: var(--accent); }
        .selected .check-ui::after { content: '✓'; position: absolute; color: #000; font-size: 11px; font-weight: 900; left: 3px; top: -1px; }
        
        .badge { background: var(--accent); color: #020617; font-size: 0.65rem; font-weight: 800; padding: 1px 6px; border-radius: 10px; margin-left: auto; }
        .btn-filter { background: #1e293b; border: 1px solid #334155; padding: 0.7rem 1rem; border-radius: 0.5rem; width: 100%; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="flex justify-between items-center mb-10">
            <h1 class="text-2xl font-extrabold">FleetAnalytics <span class="text-sky-500 text-sm">V26 FIX</span></h1>
            <div class="flex gap-3">
                <label class="cursor-pointer bg-slate-800 px-4 py-2 rounded-lg text-xs font-bold border border-slate-700">
                    <i class="fas fa-file-csv"></i> Upload CSV
                    <input type="file" accept=".csv" class="hidden" onchange="manualFile(event)">
                </label>
                <button onclick="updateFromDrive()" class="bg-sky-600 px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-2">
                    <i class="fas fa-sync-alt" id="refresh-icon"></i> Sincronizar Drive
                </button>
            </div>
        </header>

        <div class="card-v26 p-6 mb-8 grid grid-cols-1 md:grid-cols-3 gap-6 relative">
            <div class="relative">
                <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Embarcação</label>
                <div onclick="toggleMenu('menu-barco')" class="btn-filter"><span id="txt-barco">Todas</span> <i class="fas fa-chevron-down opacity-30 text-xs"></i></div>
                <div id="menu-barco" class="dropdown-menu"><div id="list-barco"></div></div>
            </div>
            <div class="relative">
                <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Tipo de Barco</label>
                <div onclick="toggleMenu('menu-tipo')" class="btn-filter"><span id="txt-tipo">Todos</span> <i class="fas fa-chevron-down opacity-30 text-xs"></i></div>
                <div id="menu-tipo" class="dropdown-menu"><div id="list-tipo"></div></div>
            </div>
            <div class="relative">
                <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Ano</label>
                <div onclick="toggleMenu('menu-ano')" class="btn-filter"><span id="txt-ano">Todos</span> <i class="fas fa-chevron-down opacity-30 text-xs"></i></div>
                <div id="menu-ano" class="dropdown-menu"><div id="list-ano"></div></div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="card-v26 p-6 border-l-4 border-sky-500">
                <p class="text-slate-500 text-[10px] font-bold uppercase mb-1">Total Notificado</p>
                <h2 id="kpi-total" class="text-xl font-bold">R$ 0,00</h2>
            </div>
            <div class="card-v26 p-6 border-l-4 border-emerald-500">
                <p class="text-slate-500 text-[10px] font-bold uppercase mb-1">Saving Total</p>
                <h2 id="kpi-saving" class="text-xl font-bold text-emerald-400">R$ 0,00</h2>
            </div>
            <div class="card-v26 p-6 border-l-4 border-indigo-500">
                <p class="text-slate-500 text-[10px] font-bold uppercase mb-1">Eficiência Defesa</p>
                <h2 id="kpi-taxa" class="text-xl font-bold text-indigo-400">0%</h2>
            </div>
            <div class="card-v26 p-6 border-l-4 border-amber-500">
                <p class="text-slate-500 text-[10px] font-bold uppercase mb-1">Volume (m³)</p>
                <h2 id="kpi-vol" class="text-xl font-bold text-amber-400">0</h2>
            </div>
        </div>

        <div class="card-v26 p-6 mb-8">
            <h3 class="text-[10px] font-bold text-slate-500 uppercase mb-4 tracking-widest">Volumes Cobrados por Ano</h3>
            <div id="year-cards" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
        </div>

        <div class="card-v26 p-8">
            <div class="h-[400px]"><canvas id="barChart"></canvas></div>
        </div>
    </div>

    <script>
        // LINK CSV PUBLICADO
        const DRIVE_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQbMe1iGMYgj5EyXKgo9uqqoekMrFTrRm7uFqQzUYkNyC_9Z7S_AuC7Bw9VCCMKXw/pub?gid=777564264&single=true&output=csv';
        
        let fullData = [], filters = { barco: [], tipo: [], ano: [] }, chart = null;

        window.onload = updateFromDrive;
        window.onclick = e => { if(!e.target.closest('.relative')) document.querySelectorAll('.dropdown-menu').forEach(m=>m.classList.remove('show')); };

        function toggleMenu(id) {
            const el = document.getElementById(id);
            const isShow = el.classList.contains('show');
            document.querySelectorAll('.dropdown-menu').forEach(m=>m.classList.remove('show'));
            if(!isShow) el.classList.add('show');
        }

        async function updateFromDrive() {
            const icon = document.getElementById('refresh-icon');
            icon.classList.add('fa-spin');
            
            Papa.parse(DRIVE_CSV, {
                download: true, header: true, skipEmptyLines: true,
                complete: r => coreProcess(r.data),
                error: (err) => { 
                    alert("Atenção: O link do Drive não retornou dados. Use o botão 'Upload CSV' enquanto verifica a publicação.");
                    icon.classList.remove('fa-spin');
                }
            });
        }

        function manualFile(e) {
            const file = e.target.files[0];
            if(file) Papa.parse(file, { header: true, skipEmptyLines: true, complete: r => coreProcess(r.data) });
        }

        function getCol(data, words) {
            if(!data[0]) return null;
            const keys = Object.keys(data[0]);
            return keys.find(k => words.some(w => k.toLowerCase().trim().includes(w)));
        }

        function coreProcess(data) {
            const kB = getCol(data, ['barco']);
            if(!kB) { alert("Erro: Não foi possível identificar a coluna de Embarcação na planilha."); return; }
            
            fullData = data.filter(d => d[kB] && d[kB].trim() !== "" && d[kB] !== 'Total');
            
            buildChecks(kB, 'list-barco', 'barco');
            buildChecks(getCol(data, ['tipo']), 'list-tipo', 'tipo');
            buildChecks(getCol(data, ['ano']), 'list-ano', 'ano');
            
            updateUI();
            document.getElementById('refresh-icon').classList.remove('fa-spin');
        }

        function buildChecks(key, containerId, filterKey) {
            if(!key) return;
            const unique = [...new Set(fullData.map(d => d[key]))].filter(x => x).sort();
            document.getElementById(containerId).innerHTML = unique.map(val => `
                <div class="option-row" onclick="handleSelect('${filterKey}', '${val}', this)">
                    <div class="check-ui"></div><span class="text-xs text-slate-300">${val}</span>
                </div>
            `).join('');
        }

        function handleSelect(type, val, el) {
            const idx = filters[type].indexOf(val);
            if(idx > -1) { filters[type].splice(idx, 1); el.classList.remove('selected'); }
            else { filters[type].push(val); el.classList.add('selected'); }
            
            const btnTxt = filters[type].length === 0 ? "Todas" : `${filters[type].length} selecionado(s)`;
            const label = document.getElementById(`txt-${type}`);
            label.innerHTML = filters[type].length === 0 ? btnTxt : `${btnTxt} <span class="badge">${filters[type].length}</span>`;
            
            updateUI();
        }

        function cleanNum(v) {
            if(!v) return 0;
            let n = v.toString().replace('R$', '').replace(/\s/g, '');
            if(n.includes(',') && n.includes('.')) n = n.replace(/\./g, '').replace(',', '.');
            else n = n.replace(',', '.');
            return parseFloat(n) || 0;
        }

        function updateUI() {
            const kB = getCol(fullData, ['barco']), kT = getCol(fullData, ['tipo']), kA = getCol(fullData, ['ano']);
            const kV = getCol(fullData, ['valor inicial', 'valor total']), kS = getCol(fullData, ['saving']), kVol = getCol(fullData, ['volume cobrado']);
            const kDef = getCol(fullData, ['defesa aceita']);

            const filtered = fullData.filter(d => {
                return (filters.barco.length === 0 || filters.barco.includes(d[kB])) &&
                       (filters.tipo.length === 0 || filters.tipo.includes(d[kT])) &&
                       (filters.ano.length === 0 || filters.ano.includes(d[kA]));
            });

            let tNot = 0, tSav = 0, tVol = 0, defA = 0, defT = 0;
            const bMap = {}, yearMap = {};

            filtered.forEach(d => {
                const n = cleanNum(d[kV]), s = cleanNum(d[kS]), v = cleanNum(d[kVol]);
                tNot += n; tSav += s; tVol += v;
                if(d[kDef]) { defT++; if(d[kDef].toUpperCase().trim() === 'SIM') defA++; }
                bMap[d[kB]] = (bMap[d[kB]] || 0) + n;
                yearMap[d[kA]] = (yearMap[d[kA]] || 0) + v;
            });

            document.getElementById('kpi-total').innerText = tNot.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('kpi-saving').innerText = tSav.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('kpi-vol').innerText = tVol.toLocaleString('pt-BR');
            document.getElementById('kpi-taxa').innerText = defT > 0 ? ((defA/defT)*100).toFixed(1) + '%' : '0%';
            
            document.getElementById('year-cards').innerHTML = Object.keys(yearMap).sort().map(y => `
                <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-800 text-center">
                    <p class="text-[9px] text-slate-500 uppercase font-bold">${y}</p>
                    <p class="text-sm font-bold text-white">${yearMap[y].toLocaleString('pt-BR')} m³</p>
                </div>
            `).join('');

            render(bMap);
        }

        function render(data) {
            const sortedB = Object.entries(data).sort((a,b)=>b[1]-a[1]).slice(0, 10);
            const ctx = document.getElementById('barChart').getContext('2d');
            if(chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedB.map(x=>x[0]),
                    datasets: [{ label: 'Impacto BRL', data: sortedB.map(x=>x[1]), backgroundColor: '#38bdf8', borderRadius: 4 }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { display: false } },
                    scales: { y: { grid:{color:'#1e293b'}, ticks:{color:'#64748b'} }, x: { ticks:{color:'#94a3b8'} } }
                }
            });
        }
    </script>
</body>
</html>