<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FleetAnalytics PRO | Dashboard Operacional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #020617; color: #f1f5f9; font-family: 'Inter', sans-serif; }
        .card-pro { background: #0f172a; border: 1px solid #1e293b; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        /* Dropdown Estilizado - Estilo Power BI */
        .dropdown-wrapper { position: relative; width: 100%; }
        .dropdown-label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: #94a3b8; margin-bottom: 0.4rem; display: block; }
        
        .dropdown-btn { 
            background: #1e293b; border: 1px solid #334155; padding: 0.6rem 1rem; border-radius: 0.5rem; 
            width: 100%; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s;
        }
        .dropdown-btn:hover { border-color: #38bdf8; }
        
        .dropdown-menu { 
            display: none; position: absolute; top: 100%; left: 0; width: 100%; 
            background: #1e293b; border: 1px solid #38bdf8; border-radius: 0.5rem; 
            z-index: 1000; max-height: 280px; overflow-y: auto; margin-top: 6px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }
        .dropdown-menu.show { display: block; }
        
        .option-row { display: flex; align-items: center; padding: 8px 12px; cursor: pointer; transition: 0.2s; border-bottom: 1px solid #0f172a; }
        .option-row:hover { background: #334155; }
        
        /* Checkbox Customizada */
        .checkbox-ui { width: 18px; height: 18px; border: 2px solid #475569; border-radius: 4px; margin-right: 12px; position: relative; flex-shrink: 0; }
        .selected .checkbox-ui { background: #38bdf8; border-color: #38bdf8; }
        .selected .checkbox-ui::after { content: '✓'; position: absolute; color: white; font-size: 11px; font-weight: bold; left: 3px; top: -1px; }
        
        .option-row span { font-size: 0.85rem; color: #cbd5e1; }
        .selected span { color: white; font-weight: 600; }

        .badge-info { background: #38bdf8; color: #020617; font-size: 0.65rem; font-weight: 800; padding: 1px 6px; border-radius: 10px; margin-left: 8px; }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-2xl font-bold tracking-tight">FleetAnalytics <span class="text-sky-500 text-sm font-medium">| Dash Operacional</span></h1>
            </div>
            <div class="flex gap-3">
                <label class="cursor-pointer bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded-lg text-xs font-bold border border-slate-700 transition">
                    <i class="fas fa-file-upload mr-2"></i> CSV Local
                    <input type="file" accept=".csv" class="hidden" onchange="loadLocal(event)">
                </label>
                <button onclick="loadDrive()" class="bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-2 transition">
                    <i class="fas fa-sync" id="spin"></i> Atualizar Drive
                </button>
            </div>
        </header>

        <div class="card-pro p-6 mb-8 grid grid-cols-1 md:grid-cols-3 gap-6 relative">
            <div class="dropdown-wrapper">
                <label class="dropdown-label">Embarcação</label>
                <div onclick="toggle('drop-barco')" class="dropdown-btn"><span id="txt-barco" class="truncate">Todas</span> <i class="fas fa-chevron-down opacity-30 text-xs"></i></div>
                <div id="drop-barco" class="dropdown-menu">
                    <div class="p-2 border-b border-slate-800"><input type="text" placeholder="Pesquisar..." class="w-full bg-slate-900 text-xs p-2 rounded outline-none border border-slate-700 focus:border-sky-500" onkeyup="search('list-barco', this.value)"></div>
                    <div id="list-barco"></div>
                </div>
            </div>
            <div class="dropdown-wrapper">
                <label class="dropdown-label">Tipo de Barco</label>
                <div onclick="toggle('drop-tipo')" class="dropdown-btn"><span id="txt-tipo" class="truncate">Todos</span> <i class="fas fa-chevron-down opacity-30 text-xs"></i></div>
                <div id="drop-tipo" class="dropdown-menu"><div id="list-tipo"></div></div>
            </div>
            <div class="dropdown-wrapper">
                <label class="dropdown-label">Período / Ano</label>
                <div onclick="toggle('drop-ano')" class="dropdown-btn"><span id="txt-ano" class="truncate">Todos</span> <i class="fas fa-chevron-down opacity-30 text-xs"></i></div>
                <div id="drop-ano" class="dropdown-menu"><div id="list-ano"></div></div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="card-pro p-5 border-l-4 border-sky-500">
                <p class="text-slate-500 text-[10px] font-bold uppercase mb-1">Total Notificado</p>
                <h2 id="total" class="text-xl font-bold">R$ 0,00</h2>
            </div>
            <div class="card-pro p-5 border-l-4 border-emerald-500">
                <p class="text-slate-500 text-[10px] font-bold uppercase mb-1">Saving Total</p>
                <h2 id="saving" class="text-xl font-bold text-emerald-400">R$ 0,00</h2>
            </div>
            <div class="card-pro p-5 border-l-4 border-indigo-500">
                <p class="text-slate-500 text-[10px] font-bold uppercase mb-1">Taxa de Sucesso</p>
                <h2 id="taxa" class="text-xl font-bold text-indigo-400">0%</h2>
            </div>
            <div class="card-pro p-5 border-l-4 border-amber-500">
                <p class="text-slate-500 text-[10px] font-bold uppercase mb-1">Volume Seleção</p>
                <h2 id="volume" class="text-xl font-bold text-amber-500">0 m³</h2>
            </div>
        </div>

        <div class="card-pro p-6 mb-8">
            <h3 class="text-[10px] font-bold text-slate-500 uppercase mb-4 tracking-widest">Distribuição de Volume por Ano (Filtro)</h3>
            <div id="grid-anos" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
        </div>

        <div class="card-pro p-8">
            <h3 class="text-[10px] font-bold text-slate-500 uppercase mb-6 tracking-widest text-center">Top 10 Impacto Financeiro (BRL)</h3>
            <div class="h-[400px]"><canvas id="mainChart"></canvas></div>
        </div>
    </div>

    <script>
        // LINK CSV FORNECIDO
        const URL_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQbMe1iGMYgj5EyXKgo9uqqoekMrFTrRm7uFqQzUYkNyC_9Z7S_AuC7Bw9VCCMKXw/pub?gid=777564264&single=true&output=csv';

        let fullData = [], filters = { barco: [], tipo: [], ano: [] }, chart = null;

        window.onload = loadDrive;
        window.onclick = e => { if(!e.target.closest('.dropdown-wrapper')) document.querySelectorAll('.dropdown-menu').forEach(d=>d.classList.remove('show')); };

        function toggle(id) {
            const el = document.getElementById(id);
            const isShow = el.classList.contains('show');
            document.querySelectorAll('.dropdown-menu').forEach(d=>d.classList.remove('show'));
            if(!isShow) el.classList.add('show');
        }

        async function loadDrive() {
            document.getElementById('spin').classList.add('fa-spin');
            Papa.parse(URL_CSV, {
                download: true, header: true, skipEmptyLines: true,
                complete: r => process(r.data),
                error: () => { alert("Falha ao ler o CSV. Verifique o link de publicação."); document.getElementById('spin').classList.remove('fa-spin'); }
            });
        }

        function loadLocal(e) {
            const file = e.target.files[0];
            if(file) Papa.parse(file, { header: true, skipEmptyLines: true, complete: r => process(r.data) });
        }

        function findCol(data, words) {
            const keys = Object.keys(data[0]);
            return keys.find(k => words.some(w => k.toLowerCase().trim().includes(w)));
        }

        function process(data) {
            const kB = findCol(data, ['barco']);
            fullData = data.filter(d => d[kB] && d[kB].trim() !== "" && d[kB] !== 'Total');
            
            build(kB, 'list-barco', 'barco');
            build(findCol(data, ['tipo']), 'list-tipo', 'tipo');
            build(findCol(data, ['ano']), 'list-ano', 'ano');
            
            update();
            document.getElementById('spin').classList.remove('fa-spin');
        }

        function build(key, listId, type) {
            if(!key) return;
            const unique = [...new Set(fullData.map(d => d[key]))].filter(x => x).sort();
            document.getElementById(listId).innerHTML = unique.map(v => `
                <div class="option-row" onclick="select('${type}', '${v}', this)">
                    <div class="checkbox-ui"></div><span>${v}</span>
                </div>
            `).join('');
        }

        function select(type, val, el) {
            const idx = filters[type].indexOf(val);
            if(idx > -1) { filters[type].splice(idx, 1); el.classList.remove('selected'); }
            else { filters[type].push(val); el.classList.add('selected'); }
            
            const btnText = filters[type].length === 0 ? "Todas" : `${filters[type].length} selecionado(s)`;
            const label = document.getElementById(`txt-${type}`);
            label.innerHTML = filters[type].length === 0 ? btnText : `${btnText} <span class="badge-info">${filters[type].length}</span>`;
            
            update();
        }

        function search(listId, val) {
            const rows = document.querySelectorAll(`#${listId} .option-row`);
            rows.forEach(r => r.style.display = r.innerText.toLowerCase().includes(val.toLowerCase()) ? 'flex' : 'none');
        }

        function cleanNum(v) {
            if(!v) return 0;
            let n = v.toString().replace('R$', '').replace(/\s/g, '');
            if(n.includes(',') && n.includes('.')) n = n.replace(/\./g, '').replace(',', '.');
            else n = n.replace(',', '.');
            return parseFloat(n) || 0;
        }

        function update() {
            const kB = findCol(fullData, ['barco']), kT = findCol(fullData, ['tipo']), kA = findCol(fullData, ['ano']);
            const kV = findCol(fullData, ['valor inicial', 'valor total']), kS = findCol(fullData, ['saving']), kVol = findCol(fullData, ['volume cobrado']);
            const kDef = findCol(fullData, ['defesa aceita']);

            const filtered = fullData.filter(d => {
                return (filters.barco.length === 0 || filters.barco.includes(d[kB])) &&
                       (filters.tipo.length === 0 || filters.tipo.includes(d[kT])) &&
                       (filters.ano.length === 0 || filters.ano.includes(d[kA]));
            });

            let tN = 0, tS = 0, tV = 0, defA = 0, defT = 0;
            const bMap = {}, yMap = {};

            filtered.forEach(d => {
                const n = cleanNum(d[kV]), s = cleanNum(d[kS]), v = cleanNum(d[kVol]);
                tN += n; tS += s; tV += v;
                
                if(d[kDef]) {
                    defT++;
                    if(d[kDef].toUpperCase().trim() === 'SIM') defA++;
                }
                
                bMap[d[kB]] = (bMap[d[kB]] || 0) + n;
                yMap[d[kA]] = (yMap[d[kA]] || 0) + v;
            });

            document.getElementById('total').innerText = tN.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('saving').innerText = tS.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('volume').innerText = tV.toLocaleString('pt-BR') + ' m³';
            document.getElementById('taxa').innerText = defT > 0 ? ((defA/defT)*100).toFixed(1) + '%' : '0%';
            
            document.getElementById('grid-anos').innerHTML = Object.keys(yMap).filter(y => y !== "undefined").sort().map(y => `
                <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-800 text-center">
                    <p class="text-[9px] text-slate-500 uppercase font-bold mb-1">${y}</p>
                    <p class="text-sm font-bold text-slate-200">${yMap[y].toLocaleString('pt-BR')} m³</p>
                </div>
            `).join('');

            render(bMap);
        }

        function render(data) {
            const sorted = Object.entries(data).sort((a,b)=>b[1]-a[1]).slice(0, 10);
            const ctx = document.getElementById('mainChart').getContext('2d');
            if(chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(x=>x[0]),
                    datasets: [{ label: 'Impacto BRL', data: sorted.map(x=>x[1]), backgroundColor: '#38bdf8', borderRadius: 4 }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { display: false } },
                    scales: { y: { grid:{color:'#1e293b'}, ticks:{color:'#64748b', font:{size:10}} }, x: { ticks:{color:'#94a3b8', font:{size:10}} } }
                }
            });
        }
    </script>
</body>
</html>